{% extends "base.html" %}

{% block title %}Salle {{ room_name }}{% endblock %}

{% block content %}
  <div class="box" style="text-align: center;">
    <h2 class="title">Salle d'appel : <span style="color: #12c064;">{{ room_name }}</span></h2>
    <p class="info">ConnectÃ© en tant que <strong>{{ request.user.get_full_name|default:request.user.username }}</strong></p>

    <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
      <video id="localVideo" autoplay muted style="border-radius: 8px; border: 2px solid #12c064;"></video>
      <video id="remoteVideo" autoplay style="border-radius: 8px; border: 2px solid #ccc;"></video>
    </div>

    <div class="controls" style="margin-top: 25px;">
      <button id="inviteButton" class="button">ðŸ“¤ Inviter</button>
      <button id="muteButton" class="button">ðŸ”‡ Couper le micro</button>
      <button id="videoButton" class="button">ðŸŽ¥ Couper la vidÃ©o</button>
      <button id="hangupButton" class="button button-danger">ðŸ”´ Raccrocher</button>
    </div>

    <div class="invite-box" style="margin-top: 20px;">
      <input type="text" id="inviteLink" readonly class="input" placeholder="Lien d'invitation..." />
      <button onclick="copyInvite()" class="button is-light">ðŸ“‹ Copier</button>
    </div>
  </div>

  <script>
    const roomName = "{{ room_name }}";
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const muteButton = document.getElementById('muteButton');
    const videoButton = document.getElementById('videoButton');
    const hangupButton = document.getElementById('hangupButton');
    const inviteButton = document.getElementById('inviteButton');

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(wsScheme + '://' + window.location.host + '/ws/video/' + roomName + '/');

    let localStream;
    let peerConnection;
    let isOfferer = Math.random() < 0.5;
    let audioEnabled = true;
    let videoEnabled = true;

    socket.onopen = async () => {
      await startLocalStream();
    };

    socket.onmessage = async function (e) {
      const data = JSON.parse(e.data);

      if (data.type === 'offer') {
        if (!peerConnection) await startPeerConnection();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.send(JSON.stringify({ type: 'answer', answer }));
      } else if (data.type === 'answer') {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      } else if (data.type === 'ice-candidate') {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (err) {
          console.error("Erreur ICE : ", err);
        }
      }
    };

    async function startLocalStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        await startPeerConnection();
      } catch (err) {
        alert("AccÃ¨s Ã  la camÃ©ra/micro refusÃ©.");
        console.error(err);
      }
    }

    async function startPeerConnection() {
      peerConnection = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      peerConnection.ontrack = function (event) {
        remoteVideo.srcObject = event.streams[0];
      };

      peerConnection.onicecandidate = function (event) {
        if (event.candidate) {
          socket.send(JSON.stringify({
            type: 'ice-candidate',
            candidate: event.candidate
          }));
        }
      };

      if (isOfferer) {
        peerConnection.onnegotiationneeded = async () => {
          try {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.send(JSON.stringify({ type: 'offer', offer }));
          } catch (err) {
            console.error("Erreur lors de la crÃ©ation de l'offre :", err);
          }
        };
      }
    }

    muteButton.onclick = () => {
      audioEnabled = !audioEnabled;
      localStream.getAudioTracks().forEach(track => track.enabled = audioEnabled);
      muteButton.textContent = audioEnabled ? 'ðŸ”‡ Couper le micro' : 'ðŸŽ¤ RÃ©activer le micro';
    };

    videoButton.onclick = () => {
      videoEnabled = !videoEnabled;
      localStream.getVideoTracks().forEach(track => track.enabled = videoEnabled);
      videoButton.textContent = videoEnabled ? 'ðŸŽ¥ Couper la vidÃ©o' : 'ðŸ“· RÃ©activer la vidÃ©o';
    };

    hangupButton.onclick = () => {
      if (peerConnection) peerConnection.close();
      socket.close();
      alert("Vous avez quittÃ© l'appel.");
      window.location.href = "{% url 'video_lobby' %}";
    };

    inviteButton.onclick = () => {
      const inviteUrl = window.location.href;
      document.getElementById("inviteLink").value = inviteUrl;
    };

    function copyInvite() {
      const input = document.getElementById("inviteLink");
      input.select();
      input.setSelectionRange(0, 99999);
      try {
        document.execCommand('copy');
        alert("Lien copiÃ© dans le presse-papiers !");
      } catch (err) {
        alert("Copie manuelle nÃ©cessaire.");
      }
    }
  </script>
{% endblock %}
